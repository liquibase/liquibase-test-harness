name: Create Release

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - DAT-18326

jobs:
    sonar:
      runs-on: ubuntu-latest
      steps:
          - uses: actions/checkout@v3
            with:
              fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          - name: Set up JDK 17
            uses: actions/setup-java@v3
            with:
              java-version: 17
              distribution: 'temurin'

          - name: Sonar Branch Scan
#            if: always() && !github.event.pull_request
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              LIQUIBASE_PRO_LICENSE_KEY: ${{ secrets.PRO_LICENSE_KEY }}
            run: |
              mvn -B sonar:sonar -P 'sonar,!run-proguard' -DskipTests -Dliquibase.version=${{ github.ref }}-SNAPSHOT \
              ${{ inputs.mavenArgs  }} \
              -Dsonar.scm.revision=${{ github.sha }} \
              -Dsonar.token=$SONAR_TOKEN \
              -Dsonar.java.coveragePlugin=jacoco \
              -Dsonar.branch.name=${{ github.ref }} \
              -Dsonar.qualitygate.wait=true \
              -Dsonar.organization=liquibase \
              -Dsonar.host.url='https://sonarcloud.io' \
              -Dsonar.scm.provider=git \
              -Daws.region="us-east-1"

    create-release:
      name: Create Release
      needs: sonar
      runs-on: ubuntu-latest
      steps:
          - name: Create Release Draft
            id: create-release
            uses: release-drafter/release-drafter@v5
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}