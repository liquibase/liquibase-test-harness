# Terraform Action to test Cloud Databases with test-harness

name: Oracle OCI Test Execution
concurrency: oracle-oci-run
on:
  # Triggers the workflow on a schedule for the main branch. Also allows for manual triggers
  schedule:
    - cron: '0 6 * * *' # Execute every day at 6AM UTC
  repository_dispatch:
    types: [test-harness]
  workflow_dispatch:
    inputs:
      testClasses:
        type: choice
        description: Test Suite or test class to run
        options:
          - LiquibaseHarnessSuiteTest
          - FoundationalHarnessSuiteTest
          - ChangeObjectTests
          - ChangeDataTests
          - SnapshotObjectTests
          - GenerateChangelogTest
          - FoundationalTest
          - AdvancedHarnessSuiteTest

permissions:
  contents: write
  id-token: write

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      testClasses: ${{ inputs.testClasses  || 'LiquibaseHarnessSuiteTest' }}
      triggeredRepo: ${{ steps.configure-build.outputs.triggeredRepo }}
      useProArtifacts: ${{ steps.configure-build.outputs.useProArtifacts }}
      liquibaseRepo: ${{ steps.configure-build.outputs.liquibaseRepo }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Configure Build
        id: configure-build
        uses: actions/github-script@v8
        with:
          script: |
            const helper = require('./.github/util/workflow-helper.js')({github, context});

            // Detect which repository triggered this workflow (for logging)
            const triggeredRepo = helper.getTriggeredRepository();
            console.log("Workflow triggered by repository: " + triggeredRepo);
            core.notice("Workflow triggered by repository: " + (triggeredRepo || "liquibase-test-harness (current repo)"));

            // Always use pro artifacts for Oracle OCI tests
            const liquibaseRepo = "liquibase/liquibase-pro";
            const useProArtifacts = true;
            console.log("Using pro artifacts repository: " + liquibaseRepo);
            console.log("Pro artifacts enabled: " + useProArtifacts);

            core.setOutput("liquibaseRepo", liquibaseRepo);
            core.setOutput("triggeredRepo", triggeredRepo || "liquibase-test-harness");
            core.setOutput("useProArtifacts", useProArtifacts);

  test:
    needs: [setup]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v5


      - name: Cache local Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true
          
      - name: Oracle OCI Test Run
        env:
          LIQUIBASE_PRO_LICENSE_KEY: ${{ env.PRO_LICENSE_KEY }}

        run: |
          echo "::group::Dependency Tree (PRO - liquibase-commercial)"
          mvn -B -PuseProArtifacts -DuseProArtifacts=true dependency:tree 2>&1 | grep -E "(liquibase|BUILD SUCCESS)" || true
          echo "::endgroup::"

          mvn -Dtest=${{ needs.setup.outputs.testClasses }} -DconfigFile=/harness-config-cloud.yml -DdbName=oracle -DdbVersion=oci -Dprefix=oci -DdbUsername=ADMIN -DdbPassword=${{env.TH_DB_PASSWD}} -DdbUrl='${{ env.TH_OCI_ORACLE_19c_URL }}' test

      - name: Archive Oracle OCI Test Results
        uses: actions/upload-artifact@v4
        with:
          name: oracle-oci-test-results
          path: build/spock-reports
