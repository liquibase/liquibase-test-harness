# Advanced test workflow with Actions

name: Advanced Test Execution
on:
  schedule:
    - cron: '0 6 * * *' # Execute every day at 6AM UTC
  repository_dispatch:
    types: [test-harness]
  workflow_dispatch:
    inputs:
      runDescription:
        description: 'Description of run'
        required: false
      runDetails:
        description: 'JSON details of run. Provided by automation'
        required: false
      liquibaseBranch:
        description: Liquibase branch to pull artifacts from. Leave empty to use latest commit on current branch. For forks, use the `owner:branch` format. Can support a comma separated list of branches to search for
        required: false
      ignoreLiquibaseSnapshot:
        type: boolean
        description: Don't autoconfigure Liquibase Snapshot
      databases:
        description: Databases to start up. Comma separated list of "name"
        required: true
        default: |
          ["mysql-5.6","mysql-5.7","mysql-8","mysql-8.4","postgres-12","postgres-13","postgres-14","postgres-15","postgres-16","postgres-17","mariadb-10.2","mariadb-10.3","mariadb-10.4","mariadb-10.5","mariadb-10.6",
          "mariadb-10.7","mariadb-11.4","mssql-2017","mssql-2019","mssql-2022","crdb-23.1","crdb-23.2","crdb-24.1","percona-xtradb-cluster-5.7","percona-xtradb-cluster-8.0","edb-postgres-12","edb-postgres-13","edb-postgres-14",
          "edb-postgres-15","edb-postgres-16","edb-edb-12","edb-edb-13","edb-edb-14","edb-edb-15","edb-edb-16","db2-luw","H2Database-2.2","sqlite","derby",
          "firebird-3","firebird-4","hsqldb-2.5","hsqldb-2.6","hsqldb-2.7","tidb","informix-12.10","informix-14.10","diff","diffChangelog"]

permissions:
  contents: write
  id-token: write

jobs:
  check_build_safety:
    name: Check if Build should be done
    runs-on: ubuntu-22.04
    steps:
      - name: Emit failure code if unsafe
        if: github.event.pull_request && github.event.pull_request.head.repo.full_name != 'liquibase/liquibase-test-harness'
        run: |
          echo "PR from Fork is NOT safe to build"
          exit 1

  setup:
    name: Setup
    needs: check_build_safety
    runs-on: ubuntu-22.04
    outputs:
      useLiquibaseSnapshot: ${{ steps.configure-build.outputs.useLiquibaseSnapshot }}
      liquibaseBranch: ${{ steps.configure-build.outputs.liquibaseBranch }}
      liquibaseRepo: ${{ steps.configure-build.outputs.liquibaseRepo }}
      triggeredRepo: ${{ steps.configure-build.outputs.triggeredRepo }}
      useProArtifacts: ${{ steps.configure-build.outputs.useProArtifacts }}
      databases: ${{ github.event.inputs.databases || '["mysql-5.6","mysql-5.7","mysql-8","mysql-8.4",
        "postgres-12","postgres-13","postgres-14","postgres-15","postgres-16","postgres-17","mariadb-10.2","mariadb-10.3","mariadb-10.4","mariadb-10.5","mariadb-10.6",
        "mariadb-10.7","mariadb-11.4","mssql-2017","mssql-2019","mssql-2022","crdb-23.1","crdb-23.2","crdb-24.1","percona-xtradb-cluster-5.7","percona-xtradb-cluster-8.0",
        "edb-edb-12","edb-edb-13","edb-edb-14","edb-edb-15","edb-edb-16","db2-luw","H2Database-2.2","sqlite","derby","firebird-3","firebird-4",
        "hsqldb-2.5","hsqldb-2.6","hsqldb-2.7","tidb","diff","diffChangelog"]' }}
      testClasses: ${{ 'AdvancedHarnessSuiteTest' }}
    steps:
      - uses: actions/checkout@v5

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Configure Build
        id: configure-build
        uses: actions/github-script@v8
        with:
          github-token: ${{ env.LIQUIBOT_PAT_GPM_ACCESS }}
          script: |
            const helper = require('./.github/util/workflow-helper.js')({github, context});

            let testBranchName = helper.getCurrentBranch();
            console.log("Running in liquibase-test-harness branch " + testBranchName);
            core.notice("Running in liquibase-test-harness branch " + testBranchName);

            // Detect which repository triggered this workflow (for logging)
            const triggeredRepo = helper.getTriggeredRepository();
            console.log("Workflow triggered by repository: " + triggeredRepo);
            core.notice("Workflow triggered by repository: " + (triggeredRepo || "liquibase-test-harness (current repo)"));

            // Always use pro artifacts for advanced workflows
            const liquibaseRepo = "liquibase/liquibase-pro";
            const useProArtifacts = true;
            console.log("Using pro artifacts repository: " + liquibaseRepo);
            console.log("Pro artifacts enabled: " + useProArtifacts);

            core.setOutput("liquibaseRepo", liquibaseRepo);
            core.setOutput("triggeredRepo", triggeredRepo || "liquibase-test-harness");
            core.setOutput("useProArtifacts", useProArtifacts);

            let useLiquibaseSnapshot = testBranchName !== "main"
            if ("${{ github.event.pull_request.base.ref }}" !== "") {
              useLiquibaseSnapshot = "${{ github.event.pull_request.base.ref }}" !== "main"
            }
            if (${{ inputs.ignoreLiquibaseSnapshot == true }}) {
              useLiquibaseSnapshot = false
            }

            console.log("useLiquibaseSnapshot == " + useLiquibaseSnapshot);
            core.setOutput("useLiquibaseSnapshot", useLiquibaseSnapshot);

            let liquibaseBranchName = "${{ github.event.inputs.liquibaseBranch }}" || testBranchName + ", master";
            console.log("liquibaseBranch == " + liquibaseBranchName);
            core.setOutput("liquibaseBranch", liquibaseBranchName);

            let runDescription = "${{ github.event.inputs.runDescription }}";
            if (!runDescription) {
                runDescription = "None given";
            }
            core.notice("Run Description: " + runDescription);

            let runDetails = null;
            if (context.payload && context.payload.inputs && context.payload.inputs.runDetails) {
                runDetails = JSON.parse(context.payload.inputs.runDetails);
            }
            if (!runDetails) {
              runDetails = {};

            }
            if (runDetails.notices) {
                for (let notice of runDetails.notices) {
                    core.notice(notice);
                }
            }

      - name: maven-settings-xml-action
        uses: whelk-io/maven-settings-xml-action@v22
        with:
          repositories: |
            [
              {
                "id": "liquibase",
                "url": "https://maven.pkg.github.com/liquibase/liquibase",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              },
              {
                "id": "liquibase-pro",
                "url": "https://maven.pkg.github.com/liquibase/liquibase-pro",
                "releases": {
                  "enabled": "false"
                },
                "snapshots": {
                  "enabled": "true",
                  "updatePolicy": "always"
                }
              }
            ]
          servers: |
            [
              {
                "id": "liquibase-pro",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              },
              {
                "id": "liquibase",
                "username": "liquibot",
                "password": "${{ env.LIQUIBOT_PAT_GPM_ACCESS }}"
              }
            ]

      - name: Install Snapshot Liquibase
        if: steps.configure-build.outputs.useLiquibaseSnapshot == 'true'
        env:
          GITHUB_TOKEN: ${{ env.LIQUIBOT_PAT_GPM_ACCESS }}
        run: |
          echo "::group::Install Snapshot Liquibase"
          echo "Artifact repository: ${{ steps.configure-build.outputs.liquibaseRepo }}"
          echo "Branch search: ${{ steps.configure-build.outputs.liquibaseBranch }}"
          echo "Triggered from: ${{ steps.configure-build.outputs.triggeredRepo }}"
          echo "Using pro artifacts: ${{ steps.configure-build.outputs.useProArtifacts }}"
          echo "::endgroup::"

          # Set liquibase-commercial version to 0-SNAPSHOT for development builds (Pro artifacts only)
          mvn -B versions:set-property -Dproperty=liquibase-commercial.version -DnewVersion=0-SNAPSHOT

          # Resolve Liquibase Pro dependencies from configured repository via Maven
          # This downloads liquibase-commercial (pro artifacts only)
          # Pro dependencies are available in liquibase-pro repository
          mvn -B dependency:resolve -DincludeArtifactIds=liquibase-commercial -Dartifacts=com.liquibase:liquibase-commercial:0-SNAPSHOT:jar

          echo "::group::Dependency Tree (PRO - liquibase-commercial)"
          mvn -B -PuseProArtifacts -DuseProArtifacts=true dependency:tree 2>&1 | grep -E "(liquibase|BUILD SUCCESS)" || true
          echo "::endgroup::"

          echo "::notice :: Resolved Snapshot Liquibase dependencies from ${{ steps.configure-build.outputs.liquibaseRepo }}"

      - name: Cache installed Liquibase
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/liquibase/
          key: mvn-liquibase-${{ github.run_id }}-${{ github.run_attempt }}

  test:
    runs-on: ubuntu-22.04
    needs: [ setup ]
    strategy:
      fail-fast: false
      matrix:
        database: ${{ fromJson(needs.setup.outputs.databases) }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Cache installed Liquibase
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/liquibase/
          key: mvn-liquibase-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Build ${{ matrix.database }} test infra
        working-directory: src/test/resources/docker
        run: ./create-infra.sh ${{ matrix.database }}
        env:
          REPO_URL: ${{ env.REPO_URL }}
          REPO_USER: ${{ env.REPO_USER }}
          REPO_PASSWORD: ${{ env.REPO_PASSWORD }}

      - name: Configure Liquibase Version
        if: needs.setup.outputs.useLiquibaseSnapshot == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn -B versions:set-property -Dproperty=liquibase-commercial.version -DnewVersion=0-SNAPSHOT

      - name: ${{ matrix.database }} Test Run
        run: |
          echo "::group::Dependency Tree (PRO - liquibase-commercial)"
          mvn -B -PuseProArtifacts -DuseProArtifacts=true dependency:tree 2>&1 | grep -E "(liquibase|BUILD SUCCESS)" || true
          echo "::endgroup::"

          ./src/test/resources/automation-runner.sh ${{ matrix.database }} ${{ needs.setup.outputs.testClasses }}
        env:
          LIQUIBASE_PRO_LICENSE_KEY: ${{ env.PRO_LICENSE_KEY }}

      - name: Archive ${{ matrix.database }} test results
        uses: actions/upload-artifact@v4
        if: ${{ always() }}
        with:
          name: ${{ matrix.database }}-test-results
          path: build/spock-reports

      # GitHub Actions has its own cleanup and this might be redundant
      - name: Tear down ${{ matrix.database }} test infra
        working-directory: src/test/resources/docker
        run: ./teardown-infra.sh ${{ matrix.database }}

  finish:
    name: Finish
    runs-on: ubuntu-22.04
    needs: [ setup, test ]
    if: ${{ always() }}
    steps:
      - uses: actions/checkout@v5
        if: needs.setup.outputs.useLiquibaseSnapshot == 'true'

      - name: Configure AWS credentials for vault access
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.LIQUIBASE_VAULT_OIDC_ROLE_ARN }}
          aws-region: us-east-1

      - name: Get secrets from vault
        id: vault-secrets
        uses: aws-actions/aws-secretsmanager-get-secrets@v2
        with:
          secret-ids: |
            ,/vault/liquibase
          parse-json-secrets: true

      - name: Get GitHub App token
        id: get-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ env.LIQUIBASE_GITHUB_APP_ID }}
          private-key: ${{ env.LIQUIBASE_GITHUB_APP_PRIVATE_KEY }}
          owner: liquibase
          repositories: liquibase
          permission-statuses: write 

      - name: Cache installed Liquibase
        if: needs.setup.outputs.useLiquibaseSnapshot == 'true'
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository/org/liquibase/
          key: mvn-liquibase-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Update status
        if: needs.setup.outputs.useLiquibaseSnapshot == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.get-token.outputs.token }}
          script: |
            const helper = require('./.github/util/workflow-helper.js')({github, context});

            const repoOwnerName = "${{ needs.setup.outputs.liquibaseOwner }}";
            const result = "${{ needs.test.result }}";
            const commitSha = "${{ needs.setup.outputs.liquibaseSha }}";
            const runId = "${{ github.run_id }}";

            const state = result === "success" ? "success" : "failure";

            console.log(`Setting commit status: ${state} for ${repoOwnerName}/liquibase@${commitSha}`);

            await github.rest.repos.createCommitStatus({
              owner: repoOwnerName,
              repo: "liquibase",
              sha: commitSha,
              state: state,
              context: "Run Test Harness",
              description: "Test Harness tests complete",
              target_url: `https://github.com/liquibase/liquibase-test-harness/actions/runs/${runId}`
            });
