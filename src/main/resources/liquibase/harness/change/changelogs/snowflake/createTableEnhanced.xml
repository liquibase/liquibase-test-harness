<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns:snowflake="http://www.liquibase.org/xml/ns/snowflake"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
                      http://www.liquibase.org/xml/ns/snowflake
                      http://www.liquibase.org/xml/ns/snowflake/liquibase-snowflake-latest.xsd">
    
    <!-- Include init.xml for cleanup -->
    <include file="liquibase/harness/change/changelogs/snowflake/init.xml"/>

    <changeSet author="test-harness" id="createTable-transient">
        <createTable tableName="TEST_TRANSIENT_TABLE" 
                     snowflake:transient="true"
                     snowflake:comment="Transient test table">
            <column name="id" type="INTEGER">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(100)"/>
            <column name="created_date" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <rollback>
            <dropTable tableName="TEST_TRANSIENT_TABLE"/>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="createTable-clusterBy">
        <createTable tableName="TEST_CLUSTERED_TABLE" 
                     snowflake:clusterBy="category,subcategory"
                     snowflake:comment="Table with clustering keys">
            <column name="id" type="INTEGER"/>
            <column name="category" type="VARCHAR(50)"/>
            <column name="subcategory" type="VARCHAR(50)"/>
            <column name="data" type="VARCHAR(500)"/>
            <column name="created_date" type="DATE"/>
        </createTable>
        <rollback>
            <dropTable tableName="TEST_CLUSTERED_TABLE"/>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="createTable-dataRetention">
        <createTable tableName="TEST_RETENTION_TABLE" 
                     snowflake:dataRetentionTimeInDays="7"
                     snowflake:comment="Table with data retention">
            <column name="id" type="INTEGER"/>
            <column name="data" type="VARCHAR(200)"/>
            <column name="timestamp" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <rollback>
            <dropTable tableName="TEST_RETENTION_TABLE"/>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="createTable-changeTracking">
        <sql>
            CREATE TABLE TEST_CHANGE_TRACKING_TABLE (
                id INTEGER PRIMARY KEY,
                data VARCHAR(200),
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            ) CHANGE_TRACKING = TRUE
            COMMENT = 'Table with change tracking'
        </sql>
        <rollback>
            <dropTable tableName="TEST_CHANGE_TRACKING_TABLE"/>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="createTable-fullFeatures">
        <createTable tableName="TEST_FULL_FEATURE_TABLE" 
                     snowflake:transient="true"
                     snowflake:clusterBy="category"
                     snowflake:dataRetentionTimeInDays="1"
                     snowflake:changeTracking="true"
                     snowflake:comment="Full featured Snowflake table">
            <column name="id" type="INTEGER">
                <constraints primaryKey="true"/>
            </column>
            <column name="category" type="VARCHAR(50)"/>
            <column name="data" type="VARCHAR(500)"/>
            <column name="created_date" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <rollback>
            <dropTable tableName="TEST_FULL_FEATURE_TABLE"/>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="createTable-complexTypes">
        <sql>
            CREATE TABLE TEST_COMPLEX_TYPES_TABLE (
                id INTEGER PRIMARY KEY,
                json_data VARIANT,
                array_data ARRAY,
                object_data OBJECT,
                geography_data GEOGRAPHY,
                binary_data BINARY(100),
                timestamp_ntz TIMESTAMP_NTZ,
                timestamp_ltz TIMESTAMP_LTZ,
                timestamp_tz TIMESTAMP_TZ
            ) COMMENT = 'Table with Snowflake complex data types'
        </sql>
        <rollback>
            <dropTable tableName="TEST_COMPLEX_TYPES_TABLE"/>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="alterTable-clustering">
        <sql>ALTER TABLE TEST_RETENTION_TABLE CLUSTER BY (id)</sql>
        <rollback>
            <sql>ALTER TABLE TEST_RETENTION_TABLE DROP CLUSTERING KEY</sql>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="alterTable-retention">
        <sql>ALTER TABLE TEST_CLUSTERED_TABLE SET DATA_RETENTION_TIME_IN_DAYS = 30</sql>
        <rollback>
            <sql>ALTER TABLE TEST_CLUSTERED_TABLE UNSET DATA_RETENTION_TIME_IN_DAYS</sql>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="alterTable-changeTracking">
        <sql>ALTER TABLE TEST_RETENTION_TABLE SET CHANGE_TRACKING = TRUE</sql>
        <rollback>
            <sql>ALTER TABLE TEST_RETENTION_TABLE SET CHANGE_TRACKING = FALSE</sql>
        </rollback>
    </changeSet>

    <changeSet author="test-harness" id="cleanup-tables">
        <dropTable tableName="TEST_TRANSIENT_TABLE"/>
        <dropTable tableName="TEST_CLUSTERED_TABLE"/>
        <dropTable tableName="TEST_RETENTION_TABLE"/>
        <dropTable tableName="TEST_CHANGE_TRACKING_TABLE"/>
        <dropTable tableName="TEST_FULL_FEATURE_TABLE"/>
        <dropTable tableName="TEST_COMPLEX_TYPES_TABLE"/>
    </changeSet>

</databaseChangeLog>