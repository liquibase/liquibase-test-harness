<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns:snowflake="http://www.liquibase.org/xml/ns/snowflake"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
                      http://www.liquibase.org/xml/ns/snowflake
                      http://www.liquibase.org/xml/ns/snowflake/liquibase-snowflake-latest.xsd">

    <!-- Template for a self-contained Snowflake test -->
    
    <!-- Step 1: Pre-test cleanup (always runs) -->
    <changeSet id="cleanup-${testName}" author="test-harness" runAlways="true">
        <comment>Clean up any objects from previous test runs</comment>
        <sql>DROP WAREHOUSE IF EXISTS TEST_${testName}_WH</sql>
        <!-- Add more cleanup statements as needed -->
        <rollback/>
    </changeSet>

    <!-- Step 2: Ensure prerequisites -->
    <changeSet id="prerequisites-${testName}" author="test-harness" runAlways="true">
        <comment>Ensure test prerequisites are met</comment>
        <sql>USE WAREHOUSE LTHDB_TEST_WH</sql>
        <sql>USE SCHEMA TESTHARNESS</sql>
        <rollback/>
    </changeSet>

    <!-- Step 3: The actual test -->
    <changeSet id="test-${testName}" author="test-harness">
        <comment>Actual test operation</comment>
        <snowflake:createWarehouse 
            warehouseName="TEST_${testName}_WH"
            warehouseSize="XSMALL"
            comment="Test warehouse for ${testName}"/>
        <rollback>
            <snowflake:dropWarehouse warehouseName="TEST_${testName}_WH"/>
        </rollback>
    </changeSet>

    <!-- Step 4: Post-test verification (optional) -->
    <changeSet id="verify-${testName}" author="test-harness">
        <preConditions onFail="HALT">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM INFORMATION_SCHEMA.WAREHOUSES 
                WHERE WAREHOUSE_NAME = 'TEST_${testName}_WH'
            </sqlCheck>
        </preConditions>
        <comment>Test verification passed</comment>
        <sql>SELECT 'Test ${testName} completed successfully' as result</sql>
        <rollback/>
    </changeSet>

</databaseChangeLog>